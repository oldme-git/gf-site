"use strict";(self.webpackChunkgfdoc=self.webpackChunkgfdoc||[]).push([[23993],{99646:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>s,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>a});var c=t(74848),r=t(28453);const i={title:"\u7f13\u5b58\u7ba1\u7406-\u5185\u5b58\u7f13\u5b58",sidebar_position:1},o=void 0,l={id:"\u6838\u5fc3\u7ec4\u4ef6/\u7f13\u5b58\u7ba1\u7406/\u7f13\u5b58\u7ba1\u7406-\u5185\u5b58\u7f13\u5b58",title:"\u7f13\u5b58\u7ba1\u7406-\u5185\u5b58\u7f13\u5b58",description:"\u7f13\u5b58\u7ec4\u4ef6\u9ed8\u8ba4\u63d0\u4f9b\u4e86\u4e00\u4e2a\u9ad8\u901f\u7684\u5185\u5b58\u7f13\u5b58\uff0c\u64cd\u4f5c\u6548\u7387\u975e\u5e38\u9ad8\u6548\uff0c CPU \u6027\u80fd\u635f\u8017\u5728 ns \u7eb3\u79d2\u7ea7\u522b\u3002",source:"@site/docs/4-\u6838\u5fc3\u7ec4\u4ef6/8-\u7f13\u5b58\u7ba1\u7406/1-\u7f13\u5b58\u7ba1\u7406-\u5185\u5b58\u7f13\u5b58.md",sourceDirName:"4-\u6838\u5fc3\u7ec4\u4ef6/8-\u7f13\u5b58\u7ba1\u7406",slug:"/\u6838\u5fc3\u7ec4\u4ef6/\u7f13\u5b58\u7ba1\u7406/\u7f13\u5b58\u7ba1\u7406-\u5185\u5b58\u7f13\u5b58",permalink:"/gf-site/docs/\u6838\u5fc3\u7ec4\u4ef6/\u7f13\u5b58\u7ba1\u7406/\u7f13\u5b58\u7ba1\u7406-\u5185\u5b58\u7f13\u5b58",draft:!1,unlisted:!1,editUrl:"https://github.com/gogf/gf-site/blob/main/docs/4-\u6838\u5fc3\u7ec4\u4ef6/8-\u7f13\u5b58\u7ba1\u7406/1-\u7f13\u5b58\u7ba1\u7406-\u5185\u5b58\u7f13\u5b58.md",tags:[],version:"current",lastUpdatedBy:"John",lastUpdatedAt:172951756e4,sidebarPosition:1,frontMatter:{title:"\u7f13\u5b58\u7ba1\u7406-\u5185\u5b58\u7f13\u5b58",sidebar_position:1},sidebar:"hiddenSidebar",previous:{title:"\u7f13\u5b58\u7ba1\u7406-\u63a5\u53e3\u8bbe\u8ba1",permalink:"/gf-site/docs/\u6838\u5fc3\u7ec4\u4ef6/\u7f13\u5b58\u7ba1\u7406/\u7f13\u5b58\u7ba1\u7406-\u63a5\u53e3\u8bbe\u8ba1"},next:{title:"\u7f13\u5b58\u7ba1\u7406-Redis\u7f13\u5b58",permalink:"/gf-site/docs/\u6838\u5fc3\u7ec4\u4ef6/\u7f13\u5b58\u7ba1\u7406/\u7f13\u5b58\u7ba1\u7406-Redis\u7f13\u5b58"}},s={},a=[{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b",level:2},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528",level:3},{value:"\u8fc7\u671f\u63a7\u5236",id:"\u8fc7\u671f\u63a7\u5236",level:3},{value:"<code>GetOrSetFunc*</code>",id:"getorsetfunc",level:3},{value:"<code>LRU</code> \u7f13\u5b58\u6dd8\u6c70\u63a7\u5236",id:"lru-\u7f13\u5b58\u6dd8\u6c70\u63a7\u5236",level:3},{value:"\u6027\u80fd\u6d4b\u8bd5",id:"\u6027\u80fd\u6d4b\u8bd5",level:2},{value:"\u6d4b\u8bd5\u73af\u5883",id:"\u6d4b\u8bd5\u73af\u5883",level:3},{value:"\u6d4b\u8bd5\u7ed3\u679c",id:"\u6d4b\u8bd5\u7ed3\u679c",level:3}];function d(n){const e={code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...n.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(e.p,{children:["\u7f13\u5b58\u7ec4\u4ef6\u9ed8\u8ba4\u63d0\u4f9b\u4e86\u4e00\u4e2a\u9ad8\u901f\u7684\u5185\u5b58\u7f13\u5b58\uff0c\u64cd\u4f5c\u6548\u7387\u975e\u5e38\u9ad8\u6548\uff0c ",(0,c.jsx)(e.code,{children:"CPU"})," \u6027\u80fd\u635f\u8017\u5728 ",(0,c.jsx)(e.code,{children:"ns"})," \u7eb3\u79d2\u7ea7\u522b\u3002"]}),"\n",(0,c.jsx)(e.h2,{id:"\u4f7f\u7528\u793a\u4f8b",children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,c.jsx)(e.h3,{id:"\u57fa\u672c\u4f7f\u7528",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:'package main\n\nimport (\n\t"fmt"\n\t"github.com/gogf/gf/v2/os/gcache"\n\t"github.com/gogf/gf/v2/os/gctx"\n)\n\nfunc main() {\n\t// \u521b\u5efa\u4e00\u4e2a\u7f13\u5b58\u5bf9\u8c61\uff0c\n\t// \u5f53\u7136\u4e5f\u53ef\u4ee5\u4fbf\u6377\u5730\u76f4\u63a5\u4f7f\u7528gcache\u5305\u65b9\u6cd5\n\tvar (\n\t\tctx   = gctx.New()\n\t\tcache = gcache.New()\n\t)\n\n\t// \u8bbe\u7f6e\u7f13\u5b58\uff0c\u4e0d\u8fc7\u671f\n\terr := cache.Set(ctx, "k1", "v1", 0)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\t// \u83b7\u53d6\u7f13\u5b58\u503c\n\tvalue, err := cache.Get(ctx, "k1")\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(value)\n\n\t// \u83b7\u53d6\u7f13\u5b58\u5927\u5c0f\n\tsize, err := cache.Size(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(size)\n\n\t// \u7f13\u5b58\u4e2d\u662f\u5426\u5b58\u5728\u6307\u5b9a\u952e\u540d\n\tb, err := cache.Contains(ctx, "k1")\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(b)\n\n\t// \u5220\u9664\u5e76\u8fd4\u56de\u88ab\u5220\u9664\u7684\u952e\u503c\n\tremovedValue, err := cache.Remove(ctx, "k1")\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(removedValue)\n\n\t// \u5173\u95ed\u7f13\u5b58\u5bf9\u8c61\uff0c\u8ba9GC\u56de\u6536\u8d44\u6e90\n\tif err = cache.Close(ctx); err != nil {\n\t\tpanic(err)\n\t}\n}\n'})}),"\n",(0,c.jsx)(e.p,{children:"\u6267\u884c\u540e\uff0c\u8f93\u51fa\u7ed3\u679c\u4e3a\uff1a"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"v1\n1\ntrue\nv1\n"})}),"\n",(0,c.jsx)(e.h3,{id:"\u8fc7\u671f\u63a7\u5236",children:"\u8fc7\u671f\u63a7\u5236"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:'package main\n\nimport (\n\t"fmt"\n\t"github.com/gogf/gf/v2/os/gcache"\n\t"github.com/gogf/gf/v2/os/gctx"\n\t"time"\n)\n\nfunc main() {\n\tvar (\n\t\tctx = gctx.New()\n\t)\n\t// \u5f53\u952e\u540d\u4e0d\u5b58\u5728\u65f6\u5199\u5165\uff0c\u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f41000\u6beb\u79d2\n\t_, err := gcache.SetIfNotExist(ctx, "k1", "v1", time.Second)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\t// \u6253\u5370\u5f53\u524d\u7684\u952e\u540d\u5217\u8868\n\tkeys, err := gcache.Keys(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(keys)\n\n\t// \u6253\u5370\u5f53\u524d\u7684\u952e\u503c\u5217\u8868\n\tvalues, err := gcache.Values(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(values)\n\n\t// \u83b7\u53d6\u6307\u5b9a\u952e\u503c\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u65f6\u5199\u5165\uff0c\u5e76\u8fd4\u56de\u952e\u503c\n\tvalue, err := gcache.GetOrSet(ctx, "k2", "v2", 0)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(value)\n\n\t// \u6253\u5370\u5f53\u524d\u7684\u952e\u503c\u5bf9\n\tdata1, err := gcache.Data(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(data1)\n\n\t// \u7b49\u5f851\u79d2\uff0c\u4ee5\u4fbfk1:v1\u81ea\u52a8\u8fc7\u671f\n\ttime.Sleep(time.Second)\n\n\t// \u518d\u6b21\u6253\u5370\u5f53\u524d\u7684\u952e\u503c\u5bf9\uff0c\u53d1\u73b0k1:v1\u5df2\u7ecf\u8fc7\u671f\uff0c\u53ea\u5269\u4e0bk2:v2\n\tdata2, err := gcache.Data(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(data2)\n}\n'})}),"\n",(0,c.jsx)(e.p,{children:"\u6267\u884c\u540e\uff0c\u8f93\u51fa\u7ed3\u679c\u4e3a\uff1a"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"[k1]\n[v1]\nv2\nmap[k1:v1 k2:v2]\nmap[k2:v2]\n"})}),"\n",(0,c.jsx)(e.h3,{id:"getorsetfunc",children:(0,c.jsx)(e.code,{children:"GetOrSetFunc*"})}),"\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.code,{children:"GetOrSetFunc"})," \u83b7\u53d6\u4e00\u4e2a\u7f13\u5b58\u503c\uff0c\u5f53\u7f13\u5b58\u4e0d\u5b58\u5728\u65f6\u6267\u884c\u6307\u5b9a\u7684 ",(0,c.jsx)(e.code,{children:"f func(context.Context) (interface{}, error)"}),"\uff0c\u7f13\u5b58\u8be5 ",(0,c.jsx)(e.code,{children:"f"})," \u65b9\u6cd5\u7684\u7ed3\u679c\u503c\uff0c\u5e76\u8fd4\u56de\u8be5\u7ed3\u679c\u3002"]}),"\n",(0,c.jsxs)(e.p,{children:["\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c ",(0,c.jsx)(e.code,{children:"GetOrSetFunc"})," \u7684\u7f13\u5b58\u65b9\u6cd5\u53c2\u6570 ",(0,c.jsx)(e.code,{children:"f"})," \u662f\u5728\u7f13\u5b58\u7684 ",(0,c.jsx)(e.strong,{children:"\u9501\u673a\u5236\u5916\u6267\u884c"}),"\uff0c\u56e0\u6b64\u5728 ",(0,c.jsx)(e.code,{children:"f"})," \u5185\u90e8\u4e5f\u53ef\u4ee5\u5d4c\u5957\u8c03\u7528 ",(0,c.jsx)(e.code,{children:"GetOrSetFunc"}),"\u3002\u4f46\u5982\u679c ",(0,c.jsx)(e.code,{children:"f"})," \u7684\u6267\u884c\u6bd4\u8f83\u8017\u65f6\uff0c\u9ad8\u5e76\u53d1\u7684\u65f6\u5019\u5bb9\u6613\u51fa\u73b0 ",(0,c.jsx)(e.code,{children:"f"})," \u88ab\u591a\u6b21\u6267\u884c\u7684\u60c5\u51b5(\u7f13\u5b58\u8bbe\u7f6e\u53ea\u6709\u7b2c\u4e00\u4e2a\u6267\u884c\u7684 ",(0,c.jsx)(e.code,{children:"f"})," \u8fd4\u56de\u7ed3\u679c\u80fd\u591f\u8bbe\u7f6e\u6210\u529f\uff0c\u5176\u4f59\u7684\u88ab\u629b\u5f03\u6389)\u3002\u800c ",(0,c.jsx)(e.code,{children:"GetOrSetFuncLock"})," \u7684\u7f13\u5b58\u65b9\u6cd5 ",(0,c.jsx)(e.code,{children:"f"})," \u662f\u5728\u7f13\u5b58\u7684 ",(0,c.jsx)(e.strong,{children:"\u9501\u673a\u5236\u5185\u6267\u884c"}),"\uff0c\u56e0\u6b64\u53ef\u4ee5\u4fdd\u8bc1\u5f53\u7f13\u5b58\u9879\u4e0d\u5b58\u5728\u65f6\u53ea\u4f1a\u6267\u884c\u4e00\u6b21 ",(0,c.jsx)(e.code,{children:"f"}),"\uff0c\u4f46\u662f\u7f13\u5b58\u5199\u9501\u7684\u65f6\u95f4\u968f\u7740 ",(0,c.jsx)(e.code,{children:"f"})," \u65b9\u6cd5\u7684\u6267\u884c\u65f6\u95f4\u800c\u5b9a\u3002"]}),"\n",(0,c.jsx)(e.p,{children:"\u6211\u4eec\u6765\u770b\u4e00\u4e2a\u793a\u4f8b\uff1a"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:'package main\n\nimport (\n\t"fmt"\n\t"github.com/gogf/gf/v2/os/gcache"\n\t"github.com/gogf/gf/v2/os/gctx"\n\t"time"\n)\n\nfunc main() {\n\tvar (\n\t\tch    = make(chan struct{}, 0)\n\t\tctx   = gctx.New()\n\t\tkey   = `key`\n\t\tvalue = `value`\n\t)\n\tfor i := 0; i < 10; i++ {\n\t\tgo func(index int) {\n\t\t\t<-ch\n\t\t\t_, err := gcache.GetOrSetFuncLock(ctx, key, func(ctx context.Context) (interface{}, error) {\n\t\t\t\tfmt.Println(index, "entered")\n\t\t\t\treturn value, nil\n\t\t\t}, 0)\n\t\t\tif err != nil {\n\t\t\t\tpanic(err)\n\t\t\t}\n\t\t}(i)\n\t}\n\tclose(ch)\n\ttime.Sleep(time.Second)\n}\n'})}),"\n",(0,c.jsx)(e.p,{children:"\u6267\u884c\u540e\uff0c\u7ec8\u7aef\u8f93\u51fa\uff08\u5e26\u6709\u968f\u673a\u6027\uff0c\u4f46\u662f\u53ea\u4f1a\u8f93\u51fa\u4e00\u6761\u4fe1\u606f\uff09\uff1a"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"9 entered\n"})}),"\n",(0,c.jsxs)(e.p,{children:["\u53ef\u4ee5\u770b\u5230\uff0c\u591a\u4e2a ",(0,c.jsx)(e.code,{children:"goroutine"})," \u540c\u65f6\u8c03\u7528 ",(0,c.jsx)(e.code,{children:"GetOrSetFuncLock"})," \u65b9\u6cd5\u65f6\uff0c\u7531\u4e8e\u8be5\u65b9\u6cd5\u6709\u5e76\u53d1\u5b89\u5168\u63a7\u5236\uff0c\u56e0\u6b64\u6700\u7ec8\u53ea\u6709\u4e00\u4e2a ",(0,c.jsx)(e.code,{children:"goroutine"})," \u7684\u6570\u503c\u751f\u6210\u51fd\u6570\u6267\u884c\u6210\u529f\uff0c\u6210\u529f\u4e4b\u540e\u5176\u4ed6 ",(0,c.jsx)(e.code,{children:"goroutine"})," \u62ff\u5230\u6570\u636e\u540e\u5219\u7acb\u5373\u8fd4\u56de\u4e0d\u518d\u6267\u884c\u5bf9\u5e94\u7684\u6570\u503c\u751f\u6210\u51fd\u6570\u3002"]}),"\n",(0,c.jsxs)(e.h3,{id:"lru-\u7f13\u5b58\u6dd8\u6c70\u63a7\u5236",children:[(0,c.jsx)(e.code,{children:"LRU"})," \u7f13\u5b58\u6dd8\u6c70\u63a7\u5236"]}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:'package main\n\nimport (\n\t"fmt"\n\t"github.com/gogf/gf/v2/os/gcache"\n\t"github.com/gogf/gf/v2/os/gctx"\n\t"time"\n)\n\nfunc main() {\n\n\tvar (\n\t\tctx   = gctx.New()\n\t\tcache = gcache.New(2) // \u8bbe\u7f6eLRU\u6dd8\u6c70\u6570\u91cf\n\t)\n\n\t// \u6dfb\u52a010\u4e2a\u5143\u7d20\uff0c\u4e0d\u8fc7\u671f\n\tfor i := 0; i < 10; i++ {\n\t\tif err := cache.Set(ctx, i, i, 0); err != nil {\n\t\t\tpanic(err)\n\t\t}\n\t}\n\tsize, err := cache.Size(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(size)\n\n\tkeys, err := cache.Keys(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(keys)\n\n\t// \u8bfb\u53d6\u952e\u540d1\uff0c\u4fdd\u8bc1\u8be5\u952e\u540d\u662f\u4f18\u5148\u4fdd\u7559\n\tvalue, err := cache.Get(ctx, 1)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(value)\n\n\t// \u7b49\u5f85\u4e00\u5b9a\u65f6\u95f4\u540e(\u9ed8\u8ba41\u79d2\u68c0\u67e5\u4e00\u6b21)\uff0c\n\t// \u5143\u7d20\u4f1a\u88ab\u6309\u7167\u4ece\u65e7\u5230\u65b0\u7684\u987a\u5e8f\u8fdb\u884c\u6dd8\u6c70\n\ttime.Sleep(3 * time.Second)\n\tsize, err = cache.Size(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(size)\n\n\tkeys, err = cache.Keys(ctx)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(keys)\n}\n'})}),"\n",(0,c.jsx)(e.p,{children:"\u6267\u884c\u540e\uff0c\u8f93\u51fa\u7ed3\u679c\u4e3a\uff1a"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"10\n[2 3 5 6 7 0 1 4 8 9]\n1\n2\n[1 9]\n"})}),"\n",(0,c.jsx)(e.h2,{id:"\u6027\u80fd\u6d4b\u8bd5",children:"\u6027\u80fd\u6d4b\u8bd5"}),"\n",(0,c.jsx)(e.h3,{id:"\u6d4b\u8bd5\u73af\u5883",children:"\u6d4b\u8bd5\u73af\u5883"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"CPU: Intel(R) Core(TM) i5-4460  CPU @ 3.20GHz\nMEM: 8GB\nSYS: Ubuntu 16.04 amd64\n"})}),"\n",(0,c.jsx)(e.h3,{id:"\u6d4b\u8bd5\u7ed3\u679c",children:"\u6d4b\u8bd5\u7ed3\u679c"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:'john@john-B85M:~/Workspace/Go/GOPATH/src/github.com/gogf/gf/v2/os/gcache$ go test *.go -bench=".*" -benchmem\ngoos: linux\ngoarch: amd64\nBenchmark_CacheSet-4                       2000000        897 ns/op      249 B/op        4 allocs/op\nBenchmark_CacheGet-4                       5000000        202 ns/op       49 B/op        1 allocs/op\nBenchmark_CacheRemove-4                   50000000       35.7 ns/op        0 B/op        0 allocs/op\nBenchmark_CacheLruSet-4                    2000000        880 ns/op      399 B/op        4 allocs/op\nBenchmark_CacheLruGet-4                    3000000        212 ns/op       33 B/op        1 allocs/op\nBenchmark_CacheLruRemove-4                50000000       35.9 ns/op        0 B/op        0 allocs/op\nBenchmark_InterfaceMapWithLockSet-4        3000000        477 ns/op       73 B/op        2 allocs/op\nBenchmark_InterfaceMapWithLockGet-4       10000000        149 ns/op        0 B/op        0 allocs/op\nBenchmark_InterfaceMapWithLockRemove-4    50000000       39.8 ns/op        0 B/op        0 allocs/op\nBenchmark_IntMapWithLockWithLockSet-4      5000000        304 ns/op       53 B/op        0 allocs/op\nBenchmark_IntMapWithLockGet-4             20000000        164 ns/op        0 B/op        0 allocs/op\nBenchmark_IntMapWithLockRemove-4          50000000       33.1 ns/op        0 B/op        0 allocs/op\nPASS\nok   command-line-arguments 47.503s\n'})})]})}function h(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,c.jsx)(e,{...n,children:(0,c.jsx)(d,{...n})}):d(n)}},28453:(n,e,t)=>{t.d(e,{R:()=>o,x:()=>l});var c=t(96540);const r={},i=c.createContext(r);function o(n){const e=c.useContext(i);return c.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:o(n.components),c.createElement(i.Provider,{value:e},n.children)}}}]);